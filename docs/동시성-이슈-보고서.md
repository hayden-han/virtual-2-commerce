# ë™ì‹œì„± ì´ìŠˆ ë³´ê³ ì„œ
## ëª©ì°¨

1. [ë¬¸ì œìƒí™©](#1-ë¬¸ì œìƒí™©)
2. [í•´ê²°ì „ëµ](#2-í•´ê²°ì „ëµ)
3. [í…ŒìŠ¤íŠ¸ê²°ê³¼](#3-í…ŒìŠ¤íŠ¸ê²°ê³¼)

---

## 1. ë¬¸ì œìƒí™©

### 1.1 ê°œìš”

ì‹œìŠ¤í…œ ë‚´ ë™ì‹œì„± ì²˜ë¦¬ê°€ í•„ìš”í•œ ì˜ì—­ì—ì„œ **4ê±´ì˜ ë™ì‹œì„± ì´ìŠˆ**ê°€ ì¡´ì¬

| ì˜ì—­                   | ë¬¸ì œ ìœ í˜•       | í˜„ì¬ ìƒíƒœ     |
|----------------------|-------------|-----------|
| ì”ì•¡ ì¶©ì „                | Lost Update | âœ… í•´ê²°ë¨     |
| ì”ì•¡ ì°¨ê°                | Race Condition | âœ… í•´ê²°ë¨     |
| ì¬ê³  ê°ì†Œ (1ê°œ ìƒí’ˆ)        | Overselling | âœ… í•´ê²°ë¨     |
| ì¬ê³  ê°ì†Œ (ëŒ€ëŸ‰ ì£¼ë¬¸)        | Overselling | âœ… í•´ê²°ë¨     |
| ì¿ í° ë°œê¸‰ (OnePerMember) | ì¤‘ë³µ ë°œê¸‰       | **ì´ìŠˆ ìˆìŒ** |

### 1.2 í˜„ì¬ ì ìš©ëœ ë™ì‹œì„± ì œì–´

| ì˜ì—­         | ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜                                 | ë¹„ê³          |
|------------|-----------------------------------------|------------|
| ì”ì•¡ ì¶©ì „      | ì¡°ê±´ë¶€ UPDATE                              | ì›ìì  ì²˜ë¦¬     |
| ì”ì•¡ ì°¨ê°      | ì¡°ê±´ë¶€ UPDATE                              | ì›ìì  ì²˜ë¦¬     |
| ì¬ê³  ê°ì†Œ      | ì¡°ê±´ë¶€ UPDATE                              | ì›ìì  ì²˜ë¦¬     |
| ì¿ í° ë°œê¸‰ (ìˆ˜ëŸ‰) | CouponIssuance Lock (SELECT FOR UPDATE) | ìˆ˜ëŸ‰ ì´ˆê³¼ ë°©ì§€   |
| ì¿ í° ì‚¬ìš© (ì£¼ë¬¸) | Member Lock (SELECT FOR UPDATE)         | ê°„ì ‘ ë³´í˜¸      |

---

### 1.3 ìƒì„¸ ë¬¸ì œ ë¶„ì„

#### 1.3.1 ì”ì•¡ ì¶©ì „ ë™ì‹œì„± ì´ìŠˆ

**ë¬¸ì œ ì½”ë“œ ìœ„ì¹˜**: `MemberBalanceService.recharge()`

**ì‹œë‚˜ë¦¬ì˜¤**
```
ì´ˆê¸° ìƒíƒœ: ì‚¬ìš©ì Aì˜ ì”ì•¡ 10,000ì›

[ë™ì‹œ ìš”ì²­]
- ìš”ì²­ 1: 5,000ì› ì¶©ì „
- ìš”ì²­ 2: 3,000ì› ì¶©ì „

ê¸°ëŒ€ ê²°ê³¼: ìµœì¢… ì”ì•¡ 18,000ì› (10,000 + 5,000 + 3,000)
ì‹¤ì œ ê²°ê³¼: 13,000ì› ë˜ëŠ” 15,000ì› (í•œ ì¶©ì „ ê¸ˆì•¡ ìœ ì‹¤)
```

**ë°œìƒ ì›ì¸**
```
ì‹œê°„ â†’
Thread 1: READ(10,000) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WRITE(15,000)
Thread 2: â”€â”€â”€â”€â”€â”€ READ(10,000) â”€â”€ WRITE(13,000)

ê²°ê³¼: Thread 1ì˜ ì¶©ì „(5,000ì›)ì´ Thread 2ì— ì˜í•´ ë®ì–´ì”€ (Lost Update)
```

**ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥**
- ê³ ê°ì´ ì¶©ì „í•œ ê¸ˆì•¡ì´ ìœ ì‹¤ë¨
- ê¸ˆì „ì  ì†ì‹¤ ë°œìƒ
- ê³ ê° ì‹ ë¢°ë„ í•˜ë½

---

#### 1.3.2 ì¬ê³  ê°ì†Œ ë™ì‹œì„± ì´ìŠˆ

**ë¬¸ì œ ì½”ë“œ ìœ„ì¹˜**: `ProductSummaryService.reduceStock()`

**ì‹œë‚˜ë¦¬ì˜¤ (1ê°œ ìƒí’ˆ)**
```
ì´ˆê¸° ìƒíƒœ: ìƒí’ˆ ì¬ê³  1ê°œ

[ë™ì‹œ ìš”ì²­ - ë‹¤ë¥¸ ì‚¬ìš©ì]
- ì‚¬ìš©ì A: 1ê°œ ì£¼ë¬¸
- ì‚¬ìš©ì B: 1ê°œ ì£¼ë¬¸

ê¸°ëŒ€ ê²°ê³¼: 1ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨ (ì¬ê³  ë¶€ì¡±)
ì‹¤ì œ ê²°ê³¼: 2ëª… ëª¨ë‘ ì„±ê³µ (Overselling)
```

**ë°œìƒ ì›ì¸**
```
ì‹œê°„ â†’
Thread 1 (User A): LOCK(member_A) â”€â”€ ì¬ê³ í™•ì¸(1) â”€â”€ ì°¨ê° â”€â”€ COMMIT
Thread 2 (User B): LOCK(member_B) â”€â”€ ì¬ê³ í™•ì¸(1) â”€â”€ ì°¨ê° â”€â”€ COMMIT

ë¬¸ì œ: Member Lockì€ ì‚¬ìš©ìë³„ë¡œ ë¶„ë¦¬ë˜ì–´ ìˆì–´,
      ë‹¤ë¥¸ ì‚¬ìš©ì ê°„ì˜ ë™ì‹œ ì¬ê³  ì ‘ê·¼ì„ ë³´í˜¸í•˜ì§€ ëª»í•¨
```

**ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥**
- ì¬ê³ ë³´ë‹¤ ë§ì€ ì£¼ë¬¸ ì ‘ìˆ˜
- ë°°ì†¡ ë¶ˆê°€ ìƒí™© ë°œìƒ
- ì£¼ë¬¸ ì·¨ì†Œ ì²˜ë¦¬ í•„ìš”
- ê³ ê° ë¶ˆë§Œ ë° ì‹ ë¢°ë„ í•˜ë½

---

#### 1.3.3 ì¿ í° ë°œê¸‰ ë™ì‹œì„± ì´ìŠˆ (OnePerMember)

**ë¬¸ì œ ì½”ë“œ ìœ„ì¹˜**: `CouponIssuanceFacade.issue()` ë‚´ ì •ì±… ê²€ì¦

**ì‹œë‚˜ë¦¬ì˜¤**
```
ì´ˆê¸° ìƒíƒœ: OnePerMember ì •ì±… ì¿ í°, ì‚¬ìš©ì Cì—ê²Œ ë¯¸ë°œê¸‰

[ë™ì‹œ ìš”ì²­ - ë™ì¼ ì‚¬ìš©ì]
- ìš”ì²­ 1: ì¿ í° ë°œê¸‰ (idempotency-key-1)
- ìš”ì²­ 2: ì¿ í° ë°œê¸‰ (idempotency-key-2)

ê¸°ëŒ€ ê²°ê³¼: 1ê±´ ì„±ê³µ, 1ê±´ ì‹¤íŒ¨ (ì´ë¯¸ ë°œê¸‰ë¨)
ì‹¤ì œ ê²°ê³¼: 2ê±´ ëª¨ë‘ ì„±ê³µ (ì¤‘ë³µ ë°œê¸‰)
```

**ë°œìƒ ì›ì¸**
```
ì‹œê°„ â†’
ìš”ì²­1: SELECT ì¿ í°(0ê°œ) â”€â”€ ì •ì±…ê²€ì¦(âœ“) â”€â”€ INSERT â”€â”€
ìš”ì²­2: â”€â”€ SELECT ì¿ í°(0ê°œ) â”€â”€ ì •ì±…ê²€ì¦(âœ“) â”€â”€ INSERT

ë¬¸ì œ: CouponIssuance Lockì€ ìˆ˜ëŸ‰ë§Œ ë³´í˜¸,
      OnePerMember ì •ì±…ì˜ ê¸°ë°œê¸‰ ì—¬ë¶€ ì²´í¬ëŠ” Lock ì—†ì´ ìˆ˜í–‰ë¨
```

**ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥**
- íšŒì›ë‹¹ 1íšŒ ë°œê¸‰ ì •ì±… ìœ„ë°˜
- ë§ˆì¼€íŒ… ì˜ˆì‚° ì´ˆê³¼
- ê³µì •ì„± ì´ìŠˆ

---

## 2. í•´ê²°ì „ëµ

> ğŸš§ **ê²€í†  ì¤‘**: ê° ì´ìŠˆë³„ í•´ê²° ì „ëµì€ ë³„ë„ ê²€í†  í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.

### 2.1 ì”ì•¡ ì¶©ì „/ì°¨ê° ë™ì‹œì„± ì œì–´

**ì„ íƒ ì „ëµ**: ì¡°ê±´ë¶€ UPDATE

**ì„ íƒ ê·¼ê±°**:
- ì›ìì  ì²˜ë¦¬: `UPDATE ... SET balance = balance + :amount` ë˜ëŠ” `UPDATE ... WHERE balance >= :amount` ë¡œ ì¡°íšŒ-ê²€ì¦-ìˆ˜ì •ì„ ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ì²˜ë¦¬
- Lock ì—†ìŒ: SELECT FOR UPDATE ëŒ€ë¹„ ì„±ëŠ¥ ìš°ìˆ˜
- ë‹¨ìˆœí•œ êµ¬ì¡°: ì¶”ê°€ ì»¬ëŸ¼ì´ë‚˜ ë³µì¡í•œ ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ ë¶ˆí•„ìš”

**êµ¬í˜„ ë°©ì•ˆ**:
1. `MemberBalanceJpaRepository`ì— ì¡°ê±´ë¶€ UPDATE ì¿¼ë¦¬ ì¶”ê°€
   - `rechargeBalance()`: `SET balance = balance + :amount WHERE id = :id`
   - `reduceBalanceByMemberId()`: `SET balance = balance - :amount WHERE member.id = :memberId AND balance >= :amount`
2. `MyBalanceOutput`ì— `atomicRecharge()`, `atomicReduceByMemberId()` ë©”ì„œë“œ ì¶”ê°€
3. `MyBalanceInteractor`ì—ì„œ ì¡°ê±´ë¶€ UPDATE ì‚¬ìš©
4. ì˜í–¥ë°›ì€ í–‰ì´ 0ì´ë©´ ì”ì•¡ ë¶€ì¡± ë˜ëŠ” ì”ê³  ì—†ìŒìœ¼ë¡œ ì²˜ë¦¬

---

### 2.2 ì¬ê³  ê°ì†Œ ë™ì‹œì„± ì œì–´

**ì„ íƒ ì „ëµ**: ì¡°ê±´ë¶€ UPDATE

**ì„ íƒ ê·¼ê±°**:
- ì¬ê³  ì¶©ë¶„ ì‹œ ë¶ˆí•„ìš”í•œ ì¬ì‹œë„ ë°©ì§€: ë‚™ê´€ì  ë½ì€ version ì¶©ëŒ ì‹œ ì¬ê³ ê°€ ì¶©ë¶„í•´ë„ ì¬ì‹œë„ í•„ìš”
- ì›ìì  ì²˜ë¦¬: `UPDATE ... WHERE stock_quantity >= :quantity` ë¡œ ì¡°íšŒ-ê²€ì¦-ìˆ˜ì •ì„ ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ì²˜ë¦¬
- ë‹¨ìˆœí•œ êµ¬ì¡°: ì¶”ê°€ ì»¬ëŸ¼ì´ë‚˜ ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ ë¶ˆí•„ìš”

**êµ¬í˜„ ë°©ì•ˆ**:
1. Repositoryì— ì¡°ê±´ë¶€ UPDATE ì¿¼ë¦¬ ì¶”ê°€
2. ì˜í–¥ë°›ì€ í–‰ì´ 0ì´ë©´ ì¬ê³  ë¶€ì¡±ìœ¼ë¡œ ì²˜ë¦¬

---

### 2.3 ì¿ í° ë°œê¸‰ ë™ì‹œì„± ì œì–´ (OnePerMember)

**í›„ë³´ ì „ëµ**

| ì „ëµ | ì„¤ëª… | ì¥ì  | ë‹¨ì  |
|------|------|------|------|
| DB Unique ì œì•½ | member_id + coupon_summary_id | í™•ì‹¤í•œ ë³´í˜¸, DB ë ˆë²¨ | ì˜ˆì™¸ ì²˜ë¦¬ í•„ìš” |
| SELECT FOR UPDATE | íšŒì› + ì¿ í° ì¡°í•© Lock | ìœ ì—°í•¨ | Lock ë³µì¡ë„ ì¦ê°€ |
| ì¡°ê±´ë¶€ INSERT | INSERT ... SELECT WHERE NOT EXISTS | ì›ìì  ì²˜ë¦¬ | ì¿¼ë¦¬ ë³µì¡ë„ |

**ì„ íƒ ì „ëµ**: `TBD`

---

## 3. í…ŒìŠ¤íŠ¸ê²°ê³¼

### 3.1 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìš”ì•½

| í…ŒìŠ¤íŠ¸ | ê²°ê³¼ | ë™ì‹œì„± ì´ìŠˆ |
|--------|------|-------------|
| ì”ì•¡ ì¶©ì „ ë™ì‹œì„± ì œì–´ | âœ… í†µê³¼ | ì—†ìŒ (ì¡°ê±´ë¶€ UPDATE) |
| ì”ì•¡ ì°¨ê° ë™ì‹œì„± ì œì–´ (ì£¼ë¬¸) | âœ… í†µê³¼ | ì—†ìŒ (ì¡°ê±´ë¶€ UPDATE) |
| ì¬ê³  ê°ì†Œ ë™ì‹œì„± ì œì–´ (1ê°œ ìƒí’ˆ) | âœ… í†µê³¼ | ì—†ìŒ (ì¡°ê±´ë¶€ UPDATE) |
| ì¬ê³  ê°ì†Œ ë™ì‹œì„± ì œì–´ (ëŒ€ëŸ‰ ì£¼ë¬¸) | âœ… í†µê³¼ | ì—†ìŒ (ì¡°ê±´ë¶€ UPDATE) |
| ì¿ í° ë°œê¸‰ ë™ì‹œì„± ì œì–´ (ìˆ˜ëŸ‰ ì œí•œ) | âœ… í†µê³¼ | ì—†ìŒ (CouponIssuance Lock) |
| ì¿ í° ë°œê¸‰ ë™ì‹œì„± ì œì–´ (OnePerMember) | âŒ ì‹¤íŒ¨ | **ìˆìŒ** |
| ì¿ í° ì‚¬ìš© ë™ì‹œì„± ì œì–´ (ì£¼ë¬¸) | âœ… í†µê³¼ | ì—†ìŒ (Member Lock) |

### 3.2 í…ŒìŠ¤íŠ¸ë³„ ìƒì„¸ ê²°ê³¼

#### ì”ì•¡ ì¶©ì „ ë™ì‹œì„± ì œì–´

```
âœ… í†µê³¼ (ì¡°ê±´ë¶€ UPDATE ì ìš©)
- ê¸°ëŒ€: 18,000ì› (10,000 + 5,000 + 3,000)
- ì‹¤ì œ: 18,000ì›
- í•´ê²° ë°©ë²•: atomicRecharge() - SET balance = balance + :amount
```

#### ì”ì•¡ ì°¨ê° ë™ì‹œì„± ì œì–´

```
âœ… í†µê³¼ (ì¡°ê±´ë¶€ UPDATE ì ìš©)
- ê¸°ëŒ€: 1ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨ (ì”ì•¡ ë¶€ì¡±)
- ì‹¤ì œ: 1ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨
- í•´ê²° ë°©ë²•: atomicReduceByMemberId() - WHERE balance >= :amount
```

#### ì¬ê³  ê°ì†Œ ë™ì‹œì„± ì œì–´ (1ê°œ ìƒí’ˆ)

```
âœ… í†µê³¼ (ì¡°ê±´ë¶€ UPDATE ì ìš©)
- ê¸°ëŒ€: 1ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨
- ì‹¤ì œ: 1ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨ (ì¬ê³  ë¶€ì¡±)
```

#### ì¬ê³  ê°ì†Œ ë™ì‹œì„± ì œì–´ (ëŒ€ëŸ‰ ì£¼ë¬¸)

```
âœ… í†µê³¼ (ì¡°ê±´ë¶€ UPDATE ì ìš©)
- ê¸°ëŒ€: ìµœëŒ€ 2ëª… ì„±ê³µ (4ê°œ íŒë§¤)
- ì‹¤ì œ: ì¬ê³  í•œë„ ë‚´ì—ì„œë§Œ ì£¼ë¬¸ ì„±ê³µ
```

#### ì¿ í° ë°œê¸‰ ë™ì‹œì„± ì œì–´ (OnePerMember)

```
âŒ ì‹¤íŒ¨
- ê¸°ëŒ€: 1ê±´ ì„±ê³µ, 1ê±´ ì‹¤íŒ¨
- ì‹¤ì œ: 2ê±´ ëª¨ë‘ ì„±ê³µ
- í•´ë‹¹ íšŒì› ì¿ í°: 2ê°œ (1ê°œì—¬ì•¼ í•¨)
```

---

### 3.3 í…ŒìŠ¤íŠ¸ íŒŒì¼ ìœ„ì¹˜

```
src/test/kotlin/kr/hhplus/be/server/application/concurrency/
â”œâ”€â”€ BalanceConcurrencyIntegrationTest.kt   # ì”ì•¡ ì¶©ì „/ì°¨ê° ë™ì‹œì„± í…ŒìŠ¤íŠ¸
â”œâ”€â”€ StockConcurrencyIntegrationTest.kt     # ì¬ê³  ê°ì†Œ ë™ì‹œì„± í…ŒìŠ¤íŠ¸
â””â”€â”€ CouponConcurrencyIntegrationTest.kt    # ì¿ í° ë°œê¸‰/ì‚¬ìš© ë™ì‹œì„± í…ŒìŠ¤íŠ¸

src/test/resources/sql/
â”œâ”€â”€ balance-concurrency-setup.sql
â”œâ”€â”€ balance-concurrency-cleanup.sql
â”œâ”€â”€ stock-concurrency-setup.sql
â”œâ”€â”€ stock-concurrency-cleanup.sql
â”œâ”€â”€ coupon-concurrency-setup.sql
â””â”€â”€ coupon-concurrency-cleanup.sql
```

### 3.4 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëª…ë ¹ì–´

```bash
# ì „ì²´ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test --tests "*ConcurrencyIntegrationTest"

# ê°œë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test --tests "BalanceConcurrencyIntegrationTest"
./gradlew test --tests "StockConcurrencyIntegrationTest"
./gradlew test --tests "CouponConcurrencyIntegrationTest"
```

---

## ë¶€ë¡

### ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ì‘ì—…ì | ë‚´ìš© |
|------|--------|------|
| 2025-12-22 | - | ì´ˆê¸° ë¬¸ì„œ ì‘ì„±, ë¬¸ì œìƒí™© ë¶„ì„ ì™„ë£Œ |
| 2025-12-22 | - | ì¬ê³  ê°ì†Œ ë™ì‹œì„± ì´ìŠˆ í•´ê²° (ì¡°ê±´ë¶€ UPDATE ì ìš©) |
| 2025-12-23 | - | ì”ì•¡ ì¶©ì „/ì°¨ê° ë™ì‹œì„± ì´ìŠˆ í•´ê²° (ì¡°ê±´ë¶€ UPDATE ì ìš©) |
