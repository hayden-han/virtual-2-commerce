# ë™ì‹œì„± ì´ìŠˆ í˜„í™©

> ì‘ì„±ì¼: 2025-12-22
> ëª©ì : ë™ì‹œì„± ì´ìŠˆ ë³´ì™„ ì „ í˜„ì¬ ì‹œìŠ¤í…œì˜ ë™ì‹œì„± ì²˜ë¦¬ ìƒíƒœ ë¶„ì„

---

## 1. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½

| í…ŒìŠ¤íŠ¸ ID | í…ŒìŠ¤íŠ¸ëª… | ê²°ê³¼ | ë™ì‹œì„± ì´ìŠˆ |
|-----------|----------|------|-------------|
| TC-BAL-001 | ì”ì•¡ ì¶©ì „ API - ë™ì‹œ ì¶©ì „ ì‹œ Lost Update ê²€ì¦ | âŒ ì‹¤íŒ¨ | **ìˆìŒ** |
| TC-BAL-002 | ì£¼ë¬¸ API - ë™ì‹œ ì£¼ë¬¸ ì‹œ ì”ì•¡ ì°¨ê° Race Condition ê²€ì¦ | âœ… í†µê³¼ | ì—†ìŒ |
| TC-STK-001 | ì¬ê³  1ê°œ ìƒí’ˆ ë™ì‹œ ì£¼ë¬¸ í…ŒìŠ¤íŠ¸ | âŒ ì‹¤íŒ¨ | **ìˆìŒ** |
| TC-STK-002 | ì¬ê³  5ê°œ ìƒí’ˆ ë™ì‹œ ëŒ€ëŸ‰ ì£¼ë¬¸ í…ŒìŠ¤íŠ¸ | âŒ ì‹¤íŒ¨ | **ìˆìŒ** |

---

## 2. í…ŒìŠ¤íŠ¸ë³„ ìƒì„¸ ë¶„ì„

### 2.1 TC-BAL-001: ì”ì•¡ ì¶©ì „ Lost Update

**ê²€ì¦ ëŒ€ìƒ**: `MemberBalanceService.recharge()` ë©”ì„œë“œ

#### ì‹œë‚˜ë¦¬ì˜¤
```
ì´ˆê¸° ìƒíƒœ: ì‚¬ìš©ì Aì˜ ì”ì•¡ 10,000ì›

[ë™ì‹œ ìš”ì²­]
- ìš”ì²­ 1: 5,000ì› ì¶©ì „
- ìš”ì²­ 2: 3,000ì› ì¶©ì „

ê¸°ëŒ€ ê²°ê³¼: ìµœì¢… ì”ì•¡ 18,000ì› (10,000 + 5,000 + 3,000)
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```
âŒ ì‹¤íŒ¨
- ê¸°ëŒ€ê°’: 18,000ì›
- ì‹¤ì œê°’: 13,000ì› (ë˜ëŠ” 15,000ì›)
- ì†ì‹¤ ê¸ˆì•¡: 5,000ì› (ë˜ëŠ” 3,000ì›)
```

#### ì›ì¸ ë¶„ì„
```
ì‹œê°„ â†’
Thread 1: READ(10,000) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WRITE(15,000)
Thread 2: â”€â”€â”€â”€â”€â”€ READ(10,000) â”€â”€ WRITE(13,000)

ê²°ê³¼: Thread 1ì˜ ì¶©ì „(5,000ì›)ì´ Thread 2ì— ì˜í•´ ë®ì–´ì¨ì§ (Lost Update)
```

#### ë¬¸ì œ ì½”ë“œ ìœ„ì¹˜
- `MemberBalanceService.recharge()`: Lock ì—†ì´ ì”ì•¡ ì¡°íšŒ í›„ ì—…ë°ì´íŠ¸

---

### 2.2 TC-BAL-002: ì£¼ë¬¸ ì‹œ ì”ì•¡ ì°¨ê° (ë™ì¼ ì‚¬ìš©ì)

**ê²€ì¦ ëŒ€ìƒ**: `PlaceOrderFacade.placeOrder()` ë‚´ ì”ì•¡ ì°¨ê° ë¡œì§

#### ì‹œë‚˜ë¦¬ì˜¤
```
ì´ˆê¸° ìƒíƒœ: ì‚¬ìš©ì Aì˜ ì”ì•¡ 15,000ì›, ìƒí’ˆ ê°€ê²© 10,000ì›

[ë™ì‹œ ìš”ì²­ - ë™ì¼ ì‚¬ìš©ì]
- ìš”ì²­ 1: 10,000ì› ìƒí’ˆ ì£¼ë¬¸ (idempotency-key-1)
- ìš”ì²­ 2: 10,000ì› ìƒí’ˆ ì£¼ë¬¸ (idempotency-key-2)

ê¸°ëŒ€ ê²°ê³¼: 1ê±´ ì„±ê³µ, 1ê±´ ì‹¤íŒ¨ (ì”ì•¡ ë¶€ì¡±)
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```
âœ… í†µê³¼
- ì„±ê³µ: 1ê±´
- ì‹¤íŒ¨: 1ê±´ (ConflictResourceException: ì”ê³ ì˜ ê¸ˆì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤)
- ìµœì¢… ì”ì•¡: 5,000ì›
```

#### í†µê³¼ ì´ìœ : Member Lockì— ì˜í•œ ë³´í˜¸
```kotlin
// PlaceOrderFacade.kt
@Transactional
fun placeOrder(...) {
    // Member ì¡°íšŒ ì‹œ Pessimistic Lock íšë“
    val member = memberQueryService.getMemberWithLock(memberId)  // FOR UPDATE

    // ì´í›„ ë¡œì§ì€ Lock ë³´í˜¸ í•˜ì— ìˆœì°¨ ì‹¤í–‰
    balanceService.reduce(...)
    stockService.reduce(...)
}
```

```
ì‹œê°„ â†’
Thread 1: LOCK(member) â”€â”€ ì”ì•¡í™•ì¸(15,000) â”€â”€ ì°¨ê° â”€â”€ COMMIT â”€â”€ UNLOCK
Thread 2: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WAIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOCK â”€â”€ ì”ì•¡í™•ì¸(5,000) â”€â”€ ì‹¤íŒ¨

ê²°ê³¼: ë™ì¼ ì‚¬ìš©ì ìš”ì²­ì´ ì§ë ¬í™”ë˜ì–´ Race Condition ë°©ì§€
```

---

### 2.3 TC-STK-001: ì¬ê³  1ê°œ ìƒí’ˆ Overselling

**ê²€ì¦ ëŒ€ìƒ**: `ProductSummaryService.reduceStock()` ë©”ì„œë“œ

#### ì‹œë‚˜ë¦¬ì˜¤
```
ì´ˆê¸° ìƒíƒœ: ìƒí’ˆ ì¬ê³  1ê°œ

[ë™ì‹œ ìš”ì²­ - ë‹¤ë¥¸ ì‚¬ìš©ì]
- ì‚¬ìš©ì A: 1ê°œ ì£¼ë¬¸
- ì‚¬ìš©ì B: 1ê°œ ì£¼ë¬¸

ê¸°ëŒ€ ê²°ê³¼: 1ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨ (ì¬ê³  ë¶€ì¡±)
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```
âŒ ì‹¤íŒ¨
- ê¸°ëŒ€: 1ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨
- ì‹¤ì œ: 2ëª… ëª¨ë‘ ì„±ê³µ
- ìƒì„±ëœ ì£¼ë¬¸: 2ê±´
- Overselling ë°œìƒ
```

#### ì›ì¸ ë¶„ì„
```
ì‹œê°„ â†’
Thread 1 (User A): LOCK(member_A) â”€â”€ ì¬ê³ í™•ì¸(1) â”€â”€ ì°¨ê° â”€â”€ COMMIT
Thread 2 (User B): LOCK(member_B) â”€â”€ ì¬ê³ í™•ì¸(1) â”€â”€ ì°¨ê° â”€â”€ COMMIT

ê²°ê³¼: Member Lockì€ ì‚¬ìš©ìë³„ë¡œ ë¶„ë¦¬ë˜ì–´ ìˆì–´,
      ë‹¤ë¥¸ ì‚¬ìš©ì ê°„ì˜ ë™ì‹œ ì¬ê³  ì ‘ê·¼ì„ ë³´í˜¸í•˜ì§€ ëª»í•¨
```

#### ë¬¸ì œì 
- **Member Lockì˜ í•œê³„**: ë™ì¼ ì‚¬ìš©ì ìš”ì²­ë§Œ ì§ë ¬í™”, ë‹¤ë¥¸ ì‚¬ìš©ì ê°„ ë³´í˜¸ ì•ˆë¨
- **Product/Stock Lock ë¶€ì¬**: ì¬ê³  ì¡°íšŒ/ì°¨ê° ì‹œ Lock ì—†ìŒ

---

### 2.4 TC-STK-002: ì¬ê³  5ê°œ ìƒí’ˆ ëŒ€ëŸ‰ Overselling

#### ì‹œë‚˜ë¦¬ì˜¤
```
ì´ˆê¸° ìƒíƒœ: ìƒí’ˆ ì¬ê³  5ê°œ

[ë™ì‹œ ìš”ì²­ - 5ëª…ì˜ ë‹¤ë¥¸ ì‚¬ìš©ì]
- ì‚¬ìš©ì C: 2ê°œ ì£¼ë¬¸
- ì‚¬ìš©ì D: 2ê°œ ì£¼ë¬¸
- ì‚¬ìš©ì E: 2ê°œ ì£¼ë¬¸
- ì‚¬ìš©ì F: 2ê°œ ì£¼ë¬¸
- ì‚¬ìš©ì G: 2ê°œ ì£¼ë¬¸

ê¸°ëŒ€ ê²°ê³¼: ìµœëŒ€ 2ëª… ì„±ê³µ (4ê°œ íŒë§¤), 3ëª… ì‹¤íŒ¨
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```
âŒ ì‹¤íŒ¨
- ê¸°ëŒ€: ìµœëŒ€ 2ëª… ì„±ê³µ
- ì‹¤ì œ: 5ëª… ëª¨ë‘ ì„±ê³µ ê°€ëŠ¥
- ì´ íŒë§¤ëŸ‰: ì´ˆê¸° ì¬ê³ (5ê°œ) ì´ˆê³¼
- ì‹¬ê°í•œ Overselling ë°œìƒ
```

---

## 3. ë™ì‹œì„± ë³´í˜¸ í˜„í™© ë§¤íŠ¸ë¦­ìŠ¤

| ê¸°ëŠ¥ | ë™ì¼ ì‚¬ìš©ì ë™ì‹œ ìš”ì²­ | ë‹¤ë¥¸ ì‚¬ìš©ì ë™ì‹œ ìš”ì²­ | ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ |
|------|----------------------|---------------------|--------------|
| ì”ì•¡ ì¶©ì „ | âŒ ë³´í˜¸ ì•ˆë¨ | N/A (ë‹¨ì¼ ì‚¬ìš©ì ê¸°ëŠ¥) | ì—†ìŒ |
| ì”ì•¡ ì°¨ê° (ì£¼ë¬¸) | âœ… ë³´í˜¸ë¨ | N/A (ì”ì•¡ì€ ì‚¬ìš©ìë³„) | Member Lock |
| ì¬ê³  ì°¨ê° (ì£¼ë¬¸) | âœ… ë³´í˜¸ë¨ | âŒ ë³´í˜¸ ì•ˆë¨ | Member Lock (ë¶ˆì™„ì „) |
| ì¿ í° ì‚¬ìš© | âœ… ë³´í˜¸ë¨ | N/A (ì¿ í°ì€ ì‚¬ìš©ìë³„) | Member Lock |

---

## 4. í˜„ì¬ Lock êµ¬ì¡° ë¶„ì„

### 4.1 Member Lock ì ìš© ë²”ìœ„

```kotlin
// MemberQueryService.kt
@Lock(LockModeType.PESSIMISTIC_WRITE)
fun getMemberWithLock(memberId: Long): Member
```

**ë³´í˜¸ ë²”ìœ„**:
- âœ… ë™ì¼ ì‚¬ìš©ìì˜ ë™ì‹œ ì£¼ë¬¸ ìš”ì²­
- âœ… ë™ì¼ ì‚¬ìš©ìì˜ ë™ì‹œ ì”ì•¡ ì°¨ê°
- âœ… ë™ì¼ ì‚¬ìš©ìì˜ ë™ì‹œ ì¿ í° ì‚¬ìš©
- âŒ ë‹¤ë¥¸ ì‚¬ìš©ì ê°„ì˜ ë™ì‹œ ì¬ê³  ì ‘ê·¼
- âŒ ì”ì•¡ ì¶©ì „ (ì£¼ë¬¸ í”Œë¡œìš°ê°€ ì•„ë‹˜)

### 4.2 Lockì´ ì—†ëŠ” ì˜ì—­

| ì˜ì—­ | ë¬¸ì œ | ì˜í–¥ |
|------|------|------|
| `MemberBalanceService.recharge()` | Lost Update | ì¶©ì „ ê¸ˆì•¡ ìœ ì‹¤ |
| `ProductSummaryService.reduceStock()` | Overselling | ì¬ê³  ì´ˆê³¼ íŒë§¤ |

---

## 5. ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥ë„

### 5.1 ì”ì•¡ ì¶©ì „ Lost Update
- **ë°œìƒ ì¡°ê±´**: ê°™ì€ ì‚¬ìš©ìê°€ ë™ì‹œì— ì—¬ëŸ¬ ë²ˆ ì¶©ì „
- **í”¼í•´**: ê³ ê°ì´ ì¶©ì „í•œ ê¸ˆì•¡ì´ ìœ ì‹¤
- **ì‹¬ê°ë„**: ğŸ”´ ë†’ìŒ (ê¸ˆì „ì  ì†ì‹¤)

### 5.2 ì¬ê³  Overselling
- **ë°œìƒ ì¡°ê±´**: ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ë™ì‹œì— ê°™ì€ ìƒí’ˆ ì£¼ë¬¸
- **í”¼í•´**: ì¬ê³ ë³´ë‹¤ ë§ì€ ì£¼ë¬¸ ì ‘ìˆ˜, ë°°ì†¡ ë¶ˆê°€
- **ì‹¬ê°ë„**: ğŸ”´ ë§¤ìš° ë†’ìŒ (ê³ ê° ë¶ˆë§Œ, ì·¨ì†Œ ì²˜ë¦¬ í•„ìš”)

---

## 6. ê¶Œì¥ ê°œì„  ì‚¬í•­

### 6.1 ì”ì•¡ ì¶©ì „ (TC-BAL-001)
```kotlin
// ë°©ë²• 1: Pessimistic Lock
@Lock(LockModeType.PESSIMISTIC_WRITE)
fun findByIdForUpdate(id: Long): MemberBalance

// ë°©ë²• 2: Optimistic Lock (@Version)
@Version
var version: Long = 0
```

### 6.2 ì¬ê³  ì°¨ê° (TC-STK-001, TC-STK-002)
```kotlin
// ë°©ë²• 1: Productì— Pessimistic Lock
@Lock(LockModeType.PESSIMISTIC_WRITE)
fun findByIdForUpdate(id: Long): ProductSummary

// ë°©ë²• 2: Redis ë¶„ì‚° ë½
fun reduceStockWithLock(productId: Long, quantity: Int) {
    redisLockTemplate.executeWithLock("stock:$productId") {
        // ì¬ê³  ì°¨ê° ë¡œì§
    }
}

// ë°©ë²• 3: Database-level ì›ìì  ì—…ë°ì´íŠ¸
@Modifying
@Query("UPDATE ProductSummary p SET p.stockQuantity = p.stockQuantity - :quantity WHERE p.id = :id AND p.stockQuantity >= :quantity")
fun reduceStock(id: Long, quantity: Int): Int  // ì˜í–¥ë°›ì€ í–‰ ìˆ˜ ë°˜í™˜
```

---

## 7. í…ŒìŠ¤íŠ¸ íŒŒì¼ ìœ„ì¹˜

| íŒŒì¼ | ê²½ë¡œ |
|------|------|
| ì”ì•¡ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ | `src/test/kotlin/.../concurrency/BalanceConcurrencyIntegrationTest.kt` |
| ì¬ê³  ë™ì‹œì„± í…ŒìŠ¤íŠ¸ | `src/test/kotlin/.../concurrency/StockConcurrencyIntegrationTest.kt` |
| ì”ì•¡ í…ŒìŠ¤íŠ¸ ë°ì´í„° | `src/test/resources/sql/balance-concurrency-setup.sql` |
| ì¬ê³  í…ŒìŠ¤íŠ¸ ë°ì´í„° | `src/test/resources/sql/stock-concurrency-setup.sql` |

---

## 8. ê²°ë¡ 

### í˜„ì¬ ìƒíƒœ
- **3ê±´ì˜ ë™ì‹œì„± ì´ìŠˆ í™•ì¸**: TC-BAL-001, TC-STK-001, TC-STK-002
- **1ê±´ì˜ ì •ìƒ ì‘ë™ í™•ì¸**: TC-BAL-002 (Member Lock ë³´í˜¸)

### Member Lockì˜ í•œê³„
í˜„ì¬ ì‹œìŠ¤í…œì˜ Member Lockì€ **"ë™ì¼ ì‚¬ìš©ìì˜ ë™ì‹œ ìš”ì²­"**ë§Œ ë³´í˜¸í•©ë‹ˆë‹¤. ì´ëŠ” ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:

| ë³´í˜¸ë¨ | ë³´í˜¸ ì•ˆë¨ |
|--------|----------|
| í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— 2ë²ˆ ê²°ì œ | ë‘ ì‚¬ìš©ìê°€ ë™ì‹œì— ë§ˆì§€ë§‰ 1ê°œ ì¬ê³  ì£¼ë¬¸ |
| í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— 2ë²ˆ ì¿ í° ì‚¬ìš© | ì¸ê¸° ìƒí’ˆ ì„ ì°©ìˆœ êµ¬ë§¤ |

### ìš°ì„ ìˆœìœ„
1. ğŸ”´ **ê¸´ê¸‰**: ì¬ê³  Overselling ë°©ì§€ (TC-STK-001, TC-STK-002)
2. ğŸŸ  **ë†’ìŒ**: ì”ì•¡ ì¶©ì „ Lost Update ë°©ì§€ (TC-BAL-001)

---

## 9. ì¿ í° ë™ì‹œì„± ë¶„ì„

### 9.1 ì¿ í° ë°œê¸‰ (ì„ ì°©ìˆœ ì¿ í°)

#### í˜„ì¬ êµ¬í˜„

```kotlin
// CouponIssuanceFacade.kt
@Transactional
override fun issue(memberId: Long, couponSummaryId: Long, now: LocalDateTime): Coupon {
    val issuance = issuanceOutput
        .findByCouponSummaryIdWithLock(couponSummaryId)  // â† Pessimistic Lock ì ìš©
        .orElseThrow { ... }

    // ì •ì±… ê²€ì¦ (OnePerMember ë“±)
    issuancePolicyOutput
        .findAllByCouponIssuanceId(issuance.id!!)
        .forEach { it.canIssue(memberId, summary) }

    val updatedIssuance = issuance.issue(now)  // issuedCount += 1
    issuanceOutput.save(updatedIssuance)

    return Coupon.create(...).let(couponOutput::save)
}
```

#### ë™ì‹œì„± ë³´í˜¸ ìƒíƒœ: âœ… ì•ˆì „

| ì‹œë‚˜ë¦¬ì˜¤ | ë³´í˜¸ ì—¬ë¶€ | ì„¤ëª… |
|----------|----------|------|
| ì„ ì°©ìˆœ 100ê°œ ì¿ í°ì— 101ëª… ë™ì‹œ ìš”ì²­ | âœ… ë³´í˜¸ë¨ | CouponIssuance Lockìœ¼ë¡œ ìˆœì°¨ ì²˜ë¦¬ |
| ë™ì¼ íšŒì› ì¤‘ë³µ ë°œê¸‰ (OnePerMember ì •ì±…) | âœ… ë³´í˜¸ë¨ | Lock í›„ ì •ì±… ê²€ì¦ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€ |

#### ë™ì‘ íë¦„
```
T1: ìš”ì²­A - Lock(CouponIssuance) íšë“
T2: ìš”ì²­B - Lock ëŒ€ê¸°...
T3: ìš”ì²­A - issuedCount í™•ì¸ (99) â†’ í†µê³¼ â†’ 100ìœ¼ë¡œ ì¦ê°€ â†’ Commit
T4: ìš”ì²­B - Lock íšë“
T5: ìš”ì²­B - issuedCount í™•ì¸ (100) â†’ maxCount ë„ë‹¬ â†’ ì‹¤íŒ¨

ê²°ê³¼: ì •í™•íˆ maxCountë§Œí¼ë§Œ ë°œê¸‰
```

---

### 9.2 ì¿ í° ì‚¬ìš© (ì£¼ë¬¸ ì‹œ)

#### í˜„ì¬ êµ¬í˜„

```kotlin
// PlaceOrderFacade.kt
@Transactional
fun placeOrder(...) {
    val member = memberOutput.findByIdWithLock(memberId)  // â† Member Lock íšë“

    // ì¿ í° ì‚¬ìš© (Lock ë³´í˜¸ í•˜ì— ì‹¤í–‰)
    val coupon = couponSummaryId?.let {
        myCouponUseCase.using(member, it, now)
    }
    ...
}

// MyCouponInteractor.kt
@Transactional
override fun using(member: Member, couponSummaryId: Long, now: LocalDateTime): Coupon {
    val usedCoupon = couponOutput
        .findByCouponSummaryIdAndMemberId(couponSummaryId, member.id!!)  // ì¼ë°˜ ì¡°íšŒ
        .orElseThrow { ... }
        .using(now)  // usingAt ì„¤ì •

    return couponOutput.save(usedCoupon)
}
```

#### ë™ì‹œì„± ë³´í˜¸ ìƒíƒœ: âœ… ì•ˆì „ (ê°„ì ‘ ë³´í˜¸)

| ì‹œë‚˜ë¦¬ì˜¤ | ë³´í˜¸ ì—¬ë¶€ | ì„¤ëª… |
|----------|----------|------|
| ë™ì¼ ì‚¬ìš©ìê°€ ê°™ì€ ì¿ í°ìœ¼ë¡œ ë™ì‹œ ì£¼ë¬¸ | âœ… ë³´í˜¸ë¨ | Member Lockìœ¼ë¡œ ìˆœì°¨ ì²˜ë¦¬ |
| ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ê°™ì€ ì¿ í° ì‚¬ìš© | N/A | ì¿ í°ì€ ì‚¬ìš©ìë³„ ì†Œìœ  |

#### ë™ì‘ íë¦„
```
T1: ìš”ì²­A (íšŒì›1) - Lock(Member 1) íšë“
T2: ìš”ì²­B (íšŒì›1) - Lock ëŒ€ê¸°...
T3: ìš”ì²­A - ì¿ í° ì‚¬ìš© â†’ usingAt ì„¤ì • â†’ Commit
T4: ìš”ì²­B - Lock íšë“
T5: ìš”ì²­B - ì¿ í° ì¡°íšŒ â†’ usingAt != null â†’ "ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°" ì˜ˆì™¸

ê²°ê³¼: ë™ì¼ ì¿ í° ì¤‘ë³µ ì‚¬ìš© ë°©ì§€
```

---

### 9.3 ì ì¬ì  ìœ„í—˜ ì˜ì—­

#### ì¿ í° ì‚¬ìš© APIê°€ ì£¼ë¬¸ ì™¸ë¶€ì— ì¡´ì¬í•˜ëŠ” ê²½ìš°

ë§Œì•½ ì£¼ë¬¸ í”Œë¡œìš°ê°€ ì•„ë‹Œ **ë³„ë„ì˜ ì¿ í° ì‚¬ìš© API**ê°€ ìˆë‹¤ë©´ ë™ì‹œì„± ì´ìŠˆ ë°œìƒ ê°€ëŠ¥:

```kotlin
// ê°€ìƒì˜ ë³„ë„ API (í˜„ì¬ ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
@PostMapping("/api/v1/coupons/{id}/use")
fun useCoupon(@PathVariable id: Long) {
    myCouponInteractor.using(...)  // Member Lock ì—†ì´ í˜¸ì¶œ
}
```

ì´ ê²½ìš° `MyCouponInteractor.using()`ì´ ì§ì ‘ í˜¸ì¶œë˜ë©´ Lock ì—†ì´ ì‹¤í–‰ë˜ì–´ ì¤‘ë³µ ì‚¬ìš© ê°€ëŠ¥.

#### í˜„ì¬ ìƒíƒœ
- **ì£¼ë¬¸ ì‹œ ì¿ í° ì‚¬ìš©**: Member Lockìœ¼ë¡œ ë³´í˜¸ë¨ âœ…
- **ë³„ë„ ì¿ í° ì‚¬ìš© API**: í˜„ì¬ ì¡´ì¬í•˜ì§€ ì•ŠìŒ (í™•ì¸ í•„ìš”)

---

### 9.4 ì¿ í° ë™ì‹œì„± ìš”ì•½

| ê¸°ëŠ¥ | ë™ì‹œì„± ì´ìŠˆ | ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ | ìƒíƒœ |
|------|------------|--------------|------|
| ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ | ìˆ˜ëŸ‰ ì´ˆê³¼ ë°œê¸‰ | `CouponIssuance` Pessimistic Lock | âœ… ì•ˆì „ |
| OnePerMember ì •ì±… | ì¤‘ë³µ ë°œê¸‰ | Lock í›„ ì •ì±… ê²€ì¦ | âœ… ì•ˆì „ |
| ì£¼ë¬¸ ì‹œ ì¿ í° ì‚¬ìš© | ì¤‘ë³µ ì‚¬ìš© | Member Lock (ê°„ì ‘ ë³´í˜¸) | âœ… ì•ˆì „ |
| ë³„ë„ ì¿ í° ì‚¬ìš© API | ì¤‘ë³µ ì‚¬ìš© | ì—†ìŒ | âš ï¸ ì ì¬ì  ìœ„í—˜ |

---

### 9.5 ê¶Œì¥ ê°œì„  ì‚¬í•­ (ì¿ í°)

#### ì¿ í° ì¡°íšŒ ì‹œ Lock ì¶”ê°€ (ë°©ì–´ì  ì½”ë”©)

```kotlin
// CouponJpaRepository.kt
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT c FROM CouponJpaEntity c WHERE c.id = :id")
fun findByIdWithLock(@Param("id") id: Long): Optional<CouponJpaEntity>
```

#### DB ì œì•½ì¡°ê±´ ì¶”ê°€

```sql
-- ë™ì¼ íšŒì›ì˜ ë™ì¼ ì¿ í° ì¤‘ë³µ ë°œê¸‰ ë°©ì§€
ALTER TABLE coupon
ADD CONSTRAINT uk_member_coupon_summary
UNIQUE (member_id, coupon_summary_id);
```
